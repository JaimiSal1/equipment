{"ast":null,"code":"import _createForOfIteratorHelper from\"/home/artagan/Desktop/equipment/web-frontend/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _classCallCheck from\"/home/artagan/Desktop/equipment/web-frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/artagan/Desktop/equipment/web-frontend/node_modules/@babel/runtime/helpers/esm/createClass\";// import WebMidi from 'webmidi';\nvar Controller=/*#__PURE__*/function(){function Controller(state,dispatch,server){_classCallCheck(this,Controller);this.server=void 0;this.dispatch=void 0;this.input=void 0;this.timeouts=void 0;this.pending_recording=void 0;this.last_state=void 0;this.last_state=state;this.dispatch=dispatch;this.server=server;this.connect();this.timeouts=new Map();this.pending_recording=false;}_createClass(Controller,[{key:\"connect\",value:function connect(){var _this=this;if(!navigator.requestMIDIAccess){console.log('WebMidi is not supported');return;}console.log('WebMidi enabled');navigator.requestMIDIAccess({sysex:true}).then(function(a){return _this.onaccess(a);},function(){return _this.onfailure();});}},{key:\"onaccess\",value:function onaccess(access){var _this2=this;var inputs=access.inputs;if(inputs.size===0){console.log('No MIDI devices detected.');}var _iterator=_createForOfIteratorHelper(inputs.entries()),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var entry=_step.value;var input=entry[1];if(!input.manufacturer)continue;this.input=input;input.onmidimessage=function(m){return _this2.onmessage(m);};return;}}catch(err){_iterator.e(err);}finally{_iterator.f();}}},{key:\"onfailure\",value:function onfailure(){console.log('WebMidi access denied');}},{key:\"onmessage\",value:function onmessage(message){var _this3=this;var channel=message.data[1];var value=message.data[2]*2;if(channel>8){if(value===0){return;}if(this.pending_recording){if(channel===45||channel===60){// record + record or record + marker set\nthis.server.save_cue(this.last_state.cue.current,this.last_state.cue.fade_time);}else if(channel===61){// record + marker left\nthis.server.save_cue(this.last_state.cue.current-1,this.last_state.cue.fade_time);}else if(channel===62){// record + marker right\nthis.server.save_cue(this.last_state.cue.current+1,this.last_state.cue.fade_time);}this.pending_recording=false;}else{if(channel===41||channel===44){// play or forward\nthis.server.go();}if(channel===42||channel===43){// stop or back\nthis.server.back();}if(channel===45){// record\nthis.pending_recording=true;}if(channel>=64&&channel<=71){// R buttons\nthis.server.reset_channel(channel-64);}}return;}// this.dispatch({type: 'update_channel', value: {channel: channel, value: value, status: 'manual'}});\nif(this.timeouts.has(channel)){clearTimeout(this.timeouts.get(channel));}this.timeouts.set(channel,window.setTimeout(function(){return _this3.ontimeout(channel,value);},1));}},{key:\"ontimeout\",value:function ontimeout(channel,value){this.server.set_level(channel,value);this.timeouts.delete(channel);}},{key:\"update_state\",value:function update_state(state){this.last_state=state;}}]);return Controller;}();export{Controller as default};","map":{"version":3,"sources":["/home/artagan/Desktop/equipment/web-frontend/src/controller.ts"],"names":["Controller","state","dispatch","server","input","timeouts","pending_recording","last_state","connect","Map","navigator","requestMIDIAccess","console","log","sysex","then","a","onaccess","onfailure","access","inputs","size","entries","entry","manufacturer","onmidimessage","m","onmessage","message","channel","data","value","save_cue","cue","current","fade_time","go","back","reset_channel","has","clearTimeout","get","set","window","setTimeout","ontimeout","set_level","delete"],"mappings":"mZAIA;GAEqBA,CAAAA,U,yBAQnB,oBAAYC,KAAZ,CAA6BC,QAA7B,CAAyDC,MAAzD,CAAyE,uCAPzEA,MAOyE,aANzED,QAMyE,aALzEE,KAKyE,aAJzEC,QAIyE,aAHzEC,iBAGyE,aAFzEC,UAEyE,QACvE,KAAKA,UAAL,CAAkBN,KAAlB,CACA,KAAKC,QAAL,CAAgBA,QAAhB,CACA,KAAKC,MAAL,CAAcA,MAAd,CACA,KAAKK,OAAL,GACA,KAAKH,QAAL,CAAgB,GAAII,CAAAA,GAAJ,EAAhB,CACA,KAAKH,iBAAL,CAAyB,KAAzB,CACD,C,gEAEiB,gBAChB,GAAI,CAACI,SAAS,CAACC,iBAAf,CAAkC,CAChCC,OAAO,CAACC,GAAR,CAAY,0BAAZ,EACA,OACD,CACDD,OAAO,CAACC,GAAR,CAAY,iBAAZ,EACAH,SAAS,CAACC,iBAAV,CAA4B,CAACG,KAAK,CAAE,IAAR,CAA5B,EAA2CC,IAA3C,CAAgD,SAACC,CAAD,QAAO,CAAA,KAAI,CAACC,QAAL,CAAcD,CAAd,CAAP,EAAhD,CAAyE,iBAAM,CAAA,KAAI,CAACE,SAAL,EAAN,EAAzE,EACD,C,0CAEgBC,M,CAA4B,iBAC3C,GAAIC,CAAAA,MAAM,CAAGD,MAAM,CAACC,MAApB,CACA,GAAIA,MAAM,CAACC,IAAP,GAAgB,CAApB,CAAuB,CACrBT,OAAO,CAACC,GAAR,CAAY,2BAAZ,EACD,CAJ0C,yCAKzBO,MAAM,CAACE,OAAP,EALyB,YAK3C,+CAAoC,IAA3BC,CAAAA,KAA2B,aAClC,GAAInB,CAAAA,KAAK,CAAGmB,KAAK,CAAC,CAAD,CAAjB,CACA,GAAI,CAACnB,KAAK,CAACoB,YAAX,CAAyB,SACzB,KAAKpB,KAAL,CAAaA,KAAb,CACAA,KAAK,CAACqB,aAAN,CAAsB,SAACC,CAAD,QAAiC,CAAA,MAAI,CAACC,SAAL,CAAeD,CAAf,CAAjC,EAAtB,CACA,OACD,CAX0C,qDAY5C,C,6CAEmB,CAClBd,OAAO,CAACC,GAAR,CAAY,uBAAZ,EACD,C,4CAEiBe,O,CAAmC,iBACnD,GAAIC,CAAAA,OAAO,CAAGD,OAAO,CAACE,IAAR,CAAa,CAAb,CAAd,CACA,GAAIC,CAAAA,KAAK,CAAGH,OAAO,CAACE,IAAR,CAAa,CAAb,EAAgB,CAA5B,CACA,GAAID,OAAO,CAAG,CAAd,CAAiB,CACf,GAAIE,KAAK,GAAK,CAAd,CAAiB,CACf,OACD,CACD,GAAI,KAAKzB,iBAAT,CAA4B,CAC1B,GAAIuB,OAAO,GAAK,EAAZ,EAAkBA,OAAO,GAAK,EAAlC,CAAsC,CACpC;AACA,KAAK1B,MAAL,CAAY6B,QAAZ,CAAqB,KAAKzB,UAAL,CAAgB0B,GAAhB,CAAoBC,OAAzC,CAAkD,KAAK3B,UAAL,CAAgB0B,GAAhB,CAAoBE,SAAtE,EACD,CAHD,IAGO,IAAIN,OAAO,GAAK,EAAhB,CAAoB,CACzB;AACA,KAAK1B,MAAL,CAAY6B,QAAZ,CAAqB,KAAKzB,UAAL,CAAgB0B,GAAhB,CAAoBC,OAApB,CAA8B,CAAnD,CAAsD,KAAK3B,UAAL,CAAgB0B,GAAhB,CAAoBE,SAA1E,EACD,CAHM,IAGA,IAAIN,OAAO,GAAK,EAAhB,CAAoB,CACzB;AACA,KAAK1B,MAAL,CAAY6B,QAAZ,CAAqB,KAAKzB,UAAL,CAAgB0B,GAAhB,CAAoBC,OAApB,CAA8B,CAAnD,CAAsD,KAAK3B,UAAL,CAAgB0B,GAAhB,CAAoBE,SAA1E,EACD,CACD,KAAK7B,iBAAL,CAAyB,KAAzB,CACD,CAZD,IAYO,CACL,GAAIuB,OAAO,GAAK,EAAZ,EAAkBA,OAAO,GAAK,EAAlC,CAAsC,CACpC;AACA,KAAK1B,MAAL,CAAYiC,EAAZ,GACD,CACD,GAAIP,OAAO,GAAK,EAAZ,EAAkBA,OAAO,GAAK,EAAlC,CAAsC,CACpC;AACA,KAAK1B,MAAL,CAAYkC,IAAZ,GACD,CACD,GAAIR,OAAO,GAAK,EAAhB,CAAoB,CAClB;AACA,KAAKvB,iBAAL,CAAyB,IAAzB,CACD,CACD,GAAIuB,OAAO,EAAI,EAAX,EAAiBA,OAAO,EAAI,EAAhC,CAAoC,CAClC;AACA,KAAK1B,MAAL,CAAYmC,aAAZ,CAA0BT,OAAO,CAAG,EAApC,EACD,CACF,CACD,OACD,CACD;AACA,GAAI,KAAKxB,QAAL,CAAckC,GAAd,CAAkBV,OAAlB,CAAJ,CAAgC,CAC9BW,YAAY,CAAC,KAAKnC,QAAL,CAAcoC,GAAd,CAAkBZ,OAAlB,CAAD,CAAZ,CACD,CACD,KAAKxB,QAAL,CAAcqC,GAAd,CAAkBb,OAAlB,CACEc,MAAM,CAACC,UAAP,CAAkB,iBAAM,CAAA,MAAI,CAACC,SAAL,CAAehB,OAAf,CAAwBE,KAAxB,CAAN,EAAlB,CAAwD,CAAxD,CADF,EAGD,C,4CAEiBF,O,CAAiBE,K,CAAe,CAChD,KAAK5B,MAAL,CAAY2C,SAAZ,CAAsBjB,OAAtB,CAA+BE,KAA/B,EACA,KAAK1B,QAAL,CAAc0C,MAAd,CAAqBlB,OAArB,EACD,C,kDAEmB5B,K,CAAiB,CACnC,KAAKM,UAAL,CAAkBN,KAAlB,CACD,C,iCAnGkBD,U","sourcesContent":["import {Dispatch} from 'react';\nimport Action from './action';\nimport Server from './server';\nimport {AppState} from './components/App/App';\n// import WebMidi from 'webmidi';\n\nexport default class Controller {\n  server: Server;\n  dispatch: Dispatch<Action>;\n  input?: WebMidi.MIDIInput;\n  timeouts: Map<number, number>;\n  pending_recording: boolean;\n  last_state: AppState;\n\n  constructor(state: AppState, dispatch: Dispatch<Action>, server: Server) {\n    this.last_state = state;\n    this.dispatch = dispatch;\n    this.server = server;\n    this.connect();\n    this.timeouts = new Map();\n    this.pending_recording = false;\n  }\n\n  private connect() {\n    if (!navigator.requestMIDIAccess) {\n      console.log('WebMidi is not supported');\n      return;\n    }\n    console.log('WebMidi enabled');\n    navigator.requestMIDIAccess({sysex: true}).then((a) => this.onaccess(a), () => this.onfailure());\n  }\n\n  private onaccess(access: WebMidi.MIDIAccess) {\n    let inputs = access.inputs;\n    if (inputs.size === 0) {\n      console.log('No MIDI devices detected.');\n    }\n    for (let entry of inputs.entries()) {\n      let input = entry[1];\n      if (!input.manufacturer) continue;\n      this.input = input;\n      input.onmidimessage = (m: WebMidi.MIDIMessageEvent) => this.onmessage(m);\n      return;\n    }\n  }\n\n  private onfailure() {\n    console.log('WebMidi access denied');\n  }\n\n  private onmessage(message: WebMidi.MIDIMessageEvent) {\n    let channel = message.data[1];\n    let value = message.data[2]*2;\n    if (channel > 8) {\n      if (value === 0) {\n        return;\n      }\n      if (this.pending_recording) {\n        if (channel === 45 || channel === 60) {\n          // record + record or record + marker set\n          this.server.save_cue(this.last_state.cue.current, this.last_state.cue.fade_time);\n        } else if (channel === 61) {\n          // record + marker left\n          this.server.save_cue(this.last_state.cue.current - 1, this.last_state.cue.fade_time);\n        } else if (channel === 62) {\n          // record + marker right\n          this.server.save_cue(this.last_state.cue.current + 1, this.last_state.cue.fade_time);\n        }\n        this.pending_recording = false;\n      } else {\n        if (channel === 41 || channel === 44) {\n          // play or forward\n          this.server.go();\n        }\n        if (channel === 42 || channel === 43) {\n          // stop or back\n          this.server.back();\n        }\n        if (channel === 45) {\n          // record\n          this.pending_recording = true;\n        }\n        if (channel >= 64 && channel <= 71) {\n          // R buttons\n          this.server.reset_channel(channel - 64);\n        }\n      }\n      return;\n    }\n    // this.dispatch({type: 'update_channel', value: {channel: channel, value: value, status: 'manual'}});\n    if (this.timeouts.has(channel)) {\n      clearTimeout(this.timeouts.get(channel));\n    }\n    this.timeouts.set(channel,\n      window.setTimeout(() => this.ontimeout(channel, value), 1)\n    );\n  }\n\n  private ontimeout(channel: number, value: number) {\n    this.server.set_level(channel, value);\n    this.timeouts.delete(channel);\n  }\n\n  public update_state(state: AppState) {\n    this.last_state = state;\n  }\n\n}\n"]},"metadata":{},"sourceType":"module"}